# Data transformation

## Game statistics

When using the NBA stats R package, requested data comes as a nested dataframe. 
Each row has data for a single season, with either regular season or playoff data. 
So if you requested 2018-19 and 2019-2020 data for the regular season and playoffs, 
4 rows would be returned. A column at the end has the actual game stats dataframes,
so these must be unnested.
```{r eval = FALSE, echo = TRUE}
covid_season_month_before <- teams_players_stats(seasons = 2020, measures = "Advanced", types = "team", tables = "general", modes = "PerGame", date_from = "2-11-20", date_to = "3-11-20") %>% 
  unnest(dataTable) %>% 
  mutate(df_type = "month_before")

bubble <- teams_players_stats(seasons = 2020, measures = "Advanced",  types = "team", season_types = c("Regular Season", "Playoffs"), tables = "general", modes = "PerGame", date_from = "7-29-20", date_to = "10-11-20") %>% 
  unnest(dataTable) 
```

We split the time periods that we wanted to compare into separate dataframes and added a new column, 
`df_type`, to distinguish them.
```{r eval = FALSE, echo = TRUE}
bubble_seeding <- bubble %>% 
  filter(typeSeason == "Regular Season") %>% 
  mutate(df_type = "bubble_seeding") 

bubble_playoffs <- bubble %>% 
  filter(typeSeason == "Playoffs") %>% 
  mutate(df_type = "bubble_playoffs")   
```

Finally, we made the data long for it to work with ggplot. The data when requested comes wide, 
with a column for each statistic.
```{r eval = FALSE, echo = TRUE}
bubble_stats_long <- bind_rows(covid_season_month_before,
                               bubble_seeding,
                               bubble_playoffs,) %>%
  select(nameTeam:paceE,
         df_type,
         -contains("rank")) %>% #drop some stats we're not interested in
  pivot_longer(gp:paceE, names_to = "rating", values_to = "value") %>%
  semi_join(bubble_teams, by = "nameTeam") #only teams that were invited to bubble
```

The same process was used for both team and player data because they come in the same form.

### COVID cases

Some additional steps were taken to integrate the COVID case data. The table from SLAM was 
crawled with `rvest` and cleaned slightly to be able to join onto the player stats. Furthermore, 
the dates were converted into date objects so that they would display in order on the x-axis.
```{r eval = FALSE, echo = TRUE}
covid_players <- read_html("https://www.slamonline.com/nba/nba-coronavirus-covid-list/") %>% 
  html_element(css = ".wp-block-table") %>% 
  html_table(header = TRUE)

covid_players_fixed <- covid_players %>% 
  rename(name = "Player",
         date_reported = "Reported") %>% 
  mutate(team_abb = str_sub(name, -4, -2),
         name = str_remove(name, " \\(.+\\)"),
         date_reported = str_remove(date_reported, " \\(.+\\)"),
         date_reported = mdy(str_c(date_reported, " 2020")))

```

## Injuries

## Player positions


## d3

A small amount of tooling was required to use the NBAstatR data with d3. To make the amount of players more manageable, we 
pared down the total number of players in the dataset to just the big names on each team. There 
are a number of players that play only a few games each year and greatly skew their ranking data. So,
get the best and most notable players, we needed to look beyond ratings. First, took data from the whole season for only _starters_. 
This already eliminates a lot of players -- only reasonably good players get to start. 
Then, we took the top 6 ranks for each team by number of games started. 

```{r eval = FALSE, echo = TRUE}
starters <- teams_players_stats(seasons = 2020, types = "player", starters_bench = list("Starters")) %>% 
  unnest(dataTable) 

top_guys_bubble <- starters %>% 
  semi_join(bubble_seeding_players, by = "namePlayer") %>% #only return players with bubble data, some players opted out
  semi_join(covid_season_players_month_before, by = "namePlayer") %>% 
  group_by(slugTeam) %>% 
  slice_max(gp, n = 6)
```


Once we found the list of players we wanted, we filtered our game data from these names. 
Then, we cut down the amount of game stats to just the ones we were interested in.
Finally, we spread the data wide by time period so that data from each period would be associated with a 
single svg element. This would allow us to access this data easily, letting us read the data just once.

Being d3 beginners, we were not sure of this approach. Maybe performance would have been better to 
add/remove dots as needed rather than load them all and hide/show them? Or even split the csv into three, 
one for each time period, loading as needed. Regardless, this approach worked!
```{r eval = FALSE, echo = TRUE}
d3_data <- bubble_season_combined %>% 
  semi_join(top_guys_bubble, by = "namePlayer") %>% 
  left_join(bubble_teams, by = "slugTeam") %>% 
  select(name = "namePlayer",
         team_abb = "slugTeam",
         team_name = "nameTeam",
         ortg,
         drtg,
         netrtg,
         df_type
         ) %>% 
  pivot_wider(names_from = "df_type", values_from = c("ortg", "drtg", "netrtg"))
 
d3_data %>%
  write_csv("data/d3_data.csv")

```
